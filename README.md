# ![GrossBuh](https://github.com/SetRandom/gross_buh/raw/master/static/icon.png) GrossBuh

## Что это

В РФ 03.07.2016 было принято нововведение в законе № 290-ФЗ - новые требования к контрольно-кассовой технике, 
а именно - печать на кассовом чеке двухмерного штрихового кода (QR-код) содержащего уникальные данные. 
Эти данные можно использовать в запросе к службам ФНС для получения электронного чека и его содержимого. 

На этом принципе и была основана идея создать автономное средство для учета личных (и не только) 
расходов который был назван **GrossBuh**.

Проект работает как сайт который можно развернуть на любом хостинге, даже в закрытой сети.

Принцип работы основан на описаниях протоколах работы с ФНС с этих ресурсов:
* https://habr.com/ru/post/358966/
* https://mjdm.ru/forum/viewtopic.php?t=3933

## Возможности

Сейчас GrossBuh имеет скромные возможности:
* Умеет получать чек от ФНС и записывать его в БД
* Если сайт ФНС не доступен или сообщает об ошибке получения, то попробуем повторить получение чека позже
* Есть скромная авторизация
* Список продуктов в чеках
* Список чеков
* Небольшие информативные страницы
* Можно отсканировать QR код с чека (с помощью [instaskan](https://schmich.github.io/instascan/))
* Можно ввести чек вручную (введя некоторые реквезиты чека или введя строку содержащуюся в qr коде)
* Логирование некоторых аспектов работы

## Установка
### Требования для установки

* Linux base distrib
* PostgreSQL 9 и выше или MariaDB (не тестировалось, но вполне может заработать)
* RabbitMQ 3
* Python 3.6 и выше



### Установка

Создайте виртуальную среду для проекта и установите в ней зависимости:
```bash
pip install -r ./requirements.txt
```
Создайте БД и пользователя имеющего полный доступ к этой БД.

Так же необходимо создать на брокере пользователя и выдать ему права (подробнее читайте в [Setting up RabbitMQ](https://docs.celeryproject.org/en/latest/getting-started/brokers/rabbitmq.html#setting-up-rabbitmq))

Сгенерируйте сертификат (без него не будет работать распознование QR кодов):
```bash
./gen_cert.sh
```

### Регистрация на ресурсах ФНС

В консоли python выполните регистрацию в ФНС при помощи модуля registration:
```python
from modules.checker_fns import registration
registration('email@example.ru', 'Name', '+79000000000')
>>> True

```
_email@example.ru_, _Name_, _+79000000000_ замените на свою электронную почту, имя (латинскими) и действующий телефон

Если все прошло успешно то вы получите на указанный телефон пароль от своей учетной записи.

## Конфигурирование

Переименуйте config_example.py в config.py и отредактируйте параметры 

Параметр | Описание
---------|---------
CHECKER_FNS_EMAIL|Электронная почта которую использовали при регистрации в ФНС
CHECKER_FNS_PHONE|Телефон
CHECKER_FNS_NAME|Имя
CHECKER_FNS_PASSWD|Пароль который получили в смс
database| [Connection URI](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING) к БД
port| Порт на котором будет доступно приложение
DEBUG| Включение дебаг режима (более информативные сообщения в работе в некоторых местах)
flask_secret_key| любой набор букв не меньше 10 символов
default_user_pwd| пароль для дефолтного пользователя user
broker_url|Connection URI к брокеру

## Запуск

### Ручной запуск

Активируйте виртуальную среду и запустите приложение:
```
python gross_buh.py
```

Затем запустите Celery активировав ту же виртуальную среду и выполнив:
```
celery -A celery_worker worker -B -l info
```

Если все прошло замечательно, то у вас должен появится доступ к вашей копии приложения по адресу: https://**вашадрес**:**порт**/
 (например **https://localhost:8011/**)
 
### Запуск через docker-compose

[Смотри здесь](https://github.com/SetRandom/gross_buh_docker)